<!DOCTYPE html>
<html lang="en">

<head>
	<title>SpaceLab Viewer</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link type="text/css" rel="stylesheet" href="main.css">
	<style>
		body {
			background: #000;
			color: #eee;
		}

		a {
			color: #0080ff;
		}

		b {
			color: orange
		}

		#planets {
			position: fixed;
			bottom: 0px;
			left: 0px;
			min-width: 200px;
			background-color: #393838c4;
			color: white;
			border-radius: 0 25px 0 0;
		}

		#planets li {
			cursor: pointer;
		}

		#planets li:hover {
			background-color: rgb(110, 110, 0);
			cursor: pointer;
		}

		#chat {
			position: fixed;
			right: 0px;
			top: 0px;
			height: 100%;
			width: 250px;
			background-color: #393838c4;
		}

		#chat h2 {
			text-align: center;
			width: 100%;
		}

		#messageList {
			list-style-type: none;
			padding: 1em;
			margin: 0;
		}
	</style>
</head>

<body>

	<div id="info">
		<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> - SpaceLab<br />
		<div id="focusname">Focused at EarthLike</div>
		<div id="connstatus">Disconnected</div>
	</div>
	<div id="planets">
		Loading planets
	</div>
	<div id="chat">
		Loading chat
	</div>

	<!-- Import maps polyfill -->
	<!-- Remove this when import maps will be widely supported -->
	<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>

	<script type="importmap">
			{
				"imports": {
					"three": "./three.module.js"
				}
			}
	</script>

	<script type="module">

		import * as THREE from 'three';

		import Stats from './stats.module.js';

		import { OrbitControls } from './OrbitControls.js';
		import { FlyControls } from './FlyControls.js';
		import { EffectComposer } from './EffectComposer.js';
		import { RenderPass } from './RenderPass.js';
		import { FilmPass } from './FilmPass.js';
		import { FontLoader } from './FontLoader.js';

		const MARGIN = 0;
		let SCREEN_HEIGHT = window.innerHeight - MARGIN * 2;
		let SCREEN_WIDTH = window.innerWidth;

		let camera, controls, scene, renderer, stats;
		let geometry, meshPlanet;
		let dirLight;
		let grids = {};
		let voxels = {};
		let ownerColors = {};
		let composer;
		let textFont;
		let planetsLoaded = false;
		let planetLayerData = {};

		const textureLoader = new THREE.TextureLoader();
		const cubeTextureLoader = new THREE.CubeTextureLoader();

		let d, dPlanet, dMoon;
		const dMoonVec = new THREE.Vector3();

		const msgList = document.createElement("ul");
		const clock = new THREE.Clock();

		function fontLoad() {
			const loader = new FontLoader();
			loader.load('helvetiker_regular.typeface.json', function (font) {
				textFont = font;
				init();
				animate();
			});
		}
		function roundRect(ctx, x, y, w, h, r) { ctx.beginPath(); ctx.moveTo(x + r, y); ctx.lineTo(x + w - r, y); ctx.quadraticCurveTo(x + w, y, x + w, y + r); ctx.lineTo(x + w, y + h - r); ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h); ctx.lineTo(x + r, y + h); ctx.quadraticCurveTo(x, y + h, x, y + h - r); ctx.lineTo(x, y + r); ctx.quadraticCurveTo(x, y, x + r, y); ctx.closePath(); ctx.fill(); ctx.stroke(); }
		function makeTextSprite(message, parameters) {
			if (parameters === undefined) parameters = {};
			var fontface = parameters.hasOwnProperty("fontface") ? parameters["fontface"] : "Arial";
			var fontsize = parameters.hasOwnProperty("fontsize") ? parameters["fontsize"] : 18;
			var borderThickness = parameters.hasOwnProperty("borderThickness") ? parameters["borderThickness"] : 4;
			var borderColor = parameters.hasOwnProperty("borderColor") ? parameters["borderColor"] : { r: 0, g: 0, b: 0, a: 1.0 };
			var backgroundColor = parameters.hasOwnProperty("backgroundColor") ? parameters["backgroundColor"] : { r: 255, g: 255, b: 255, a: 1.0 };
			var textColor = parameters.hasOwnProperty("textColor") ? parameters["textColor"] : { r: 0, g: 0, b: 0, a: 1.0 };

			var canvas = document.createElement('canvas');
			var context = canvas.getContext('2d');
			context.font = "Bold " + fontsize + "px " + fontface;
			var metrics = context.measureText(message);
			var textWidth = metrics.width;

			context.fillStyle = "rgba(" + backgroundColor.r + "," + backgroundColor.g + "," + backgroundColor.b + "," + backgroundColor.a + ")";
			context.strokeStyle = "rgba(" + borderColor.r + "," + borderColor.g + "," + borderColor.b + "," + borderColor.a + ")";

			context.lineWidth = borderThickness;
			roundRect(context, borderThickness / 2, borderThickness / 2, (textWidth + borderThickness) * 1.1, fontsize * 1.4 + borderThickness, 8);

			context.fillStyle = "rgba(" + textColor.r + ", " + textColor.g + ", " + textColor.b + ", 1.0)";
			context.fillText(message, borderThickness, fontsize + borderThickness);

			var texture = new THREE.Texture(canvas)
			texture.needsUpdate = true;
			// const map = new THREE.TextureLoader().load( './background.jpg' );
			var spriteMaterial = new THREE.SpriteMaterial({ map: texture });
			var sprite = new THREE.Sprite(spriteMaterial);
			// sprite.scale.set(0.5 * fontsize, 0.25 * fontsize, 0.75 * fontsize);
			const baseScale = 50000;
			sprite.scale.set(0.5 * baseScale, 0.25 * baseScale, 0.75 * baseScale);
			return sprite;
		}

		function newText(message) {
			return makeTextSprite(message);
		}

		fontLoad();

		function init() {
			document.getElementById("chat").innerHTML = "<h2>Chat</h2>";
			msgList.id = "messageList";
			document.getElementById("chat").appendChild(msgList);

			camera = new THREE.PerspectiveCamera(25, SCREEN_WIDTH / SCREEN_HEIGHT, 10000, 8500000);
			camera.position.z = 100e3 * 5;

			scene = new THREE.Scene();
			scene.fog = new THREE.FogExp2(0x000000, 0.00000025);
			scene.add(new THREE.AmbientLight(0x443333));

			dirLight = new THREE.DirectionalLight(0xffffff);
			dirLight.position.set(-1, 0, 1).normalize();
			scene.add(dirLight);

			const texture = cubeTextureLoader.load([
				'img/BackgroundCube-0.jpg',
				'img/BackgroundCube-1.jpg',
				'img/BackgroundCube-2.jpg',
				'img/BackgroundCube-3.jpg',
				'img/BackgroundCube-4.jpg',
				'img/BackgroundCube-5.jpg',
			]);
			scene.background = texture;

			renderer = new THREE.WebGLRenderer({ antialias: true });
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
			document.body.appendChild(renderer.domElement);

			//

			controls = new OrbitControls(camera, renderer.domElement);
			controls.minDistance = 0;
			controls.maxDistance = 200e6 * 20;
			//

			stats = new Stats();
			document.body.appendChild(stats.dom);

			window.addEventListener('resize', onWindowResize);

			const renderModel = new RenderPass(scene, camera);
			//const effectFilm = new FilmPass(0.35, 0.75, 2048, false);

			composer = new EffectComposer(renderer);

			composer.addPass(renderModel);
			//composer.addPass(effectFilm);
			const connection = new WebSocket('ws://localhost:3000/ws');
			// When the connection is open, send some data to the server
			connection.onopen = function () {
				document.getElementById('connstatus').innerHTML = "Connected";
				connection.send('Ping'); // Send the message 'Ping' to the server
			};

			// Log errors
			connection.onerror = function (error) {
				document.getElementById('connstatus').innerHTML = 'WebSocket Error ' + error;
			};

			// Log messages from the server
			connection.onmessage = function (e) {
				try {
					const data = JSON.parse(e.data);
					switch (data.Type) {
						case "planets": planetsUpdateCallback(data.Content); break;
						case "gridUpdate": gridUpdateCallback(data.Content); break;
						case "chat": newChatCallback(data.Content); break;
						case "grids": gridsCallback(data.Content); break;
					}
				} catch (e) {
					document.getElementById('connstatus').innerHTML = 'Error parsing server data:' + e;
					console.log(e);
				}
			};
		}
		function shouldScale(planetName) {
			return planetName.indexOf("Mars") >= 0 ||
				planetName.indexOf("Earth") >= 0 ||
				planetName.indexOf("Alien") >= 0;
		}
		const planetTextures = {
			"Agaris": [
				'img/planets-cube/agaris/front.jpg',
				'img/planets-cube/agaris/right.jpg',
				'img/planets-cube/agaris/up.jpg',
				'img/planets-cube/agaris/down.jpg',
				'img/planets-cube/agaris/back.jpg',
				'img/planets-cube/agaris/left.jpg',
			],
			"EarthLike": [
				'img/planets-cube/earthlike/front.jpg',
				'img/planets-cube/earthlike/right.jpg',
				'img/planets-cube/earthlike/up.jpg',
				'img/planets-cube/earthlike/down.jpg',
				'img/planets-cube/earthlike/back.jpg',
				'img/planets-cube/earthlike/left.jpg',
			],
			"Moon": [
				'img/planets-cube/moon/front.jpg',
				'img/planets-cube/moon/right.jpg',
				'img/planets-cube/moon/up.jpg',
				'img/planets-cube/moon/down.jpg',
				'img/planets-cube/moon/back.jpg',
				'img/planets-cube/moon/left.jpg',
			],
			"Mars": [
				'img/planets-cube/mars/front.jpg',
				'img/planets-cube/mars/right.jpg',
				'img/planets-cube/mars/up.jpg',
				'img/planets-cube/mars/down.jpg',
				'img/planets-cube/mars/back.jpg',
				'img/planets-cube/mars/left.jpg',
			],
			"Europa": [
				'img/planets-cube/europa/front.jpg',
				'img/planets-cube/europa/right.jpg',
				'img/planets-cube/europa/up.jpg',
				'img/planets-cube/europa/down.jpg',
				'img/planets-cube/europa/back.jpg',
				'img/planets-cube/europa/left.jpg',
			],
			"Alien": [
				'img/planets-cube/alien/front.jpg',
				'img/planets-cube/alien/right.jpg',
				'img/planets-cube/alien/up.jpg',
				'img/planets-cube/alien/down.jpg',
				'img/planets-cube/alien/back.jpg',
				'img/planets-cube/alien/left.jpg',
			],
			"Titan": [
				'img/planets-cube/titan/front.jpg',
				'img/planets-cube/titan/right.jpg',
				'img/planets-cube/titan/up.jpg',
				'img/planets-cube/titan/down.jpg',
				'img/planets-cube/titan/back.jpg',
				'img/planets-cube/titan/left.jpg',
			],
			"Pertam": [
				'img/planets-cube/pertam/front.jpg',
				'img/planets-cube/pertam/right.jpg',
				'img/planets-cube/pertam/up.jpg',
				'img/planets-cube/pertam/down.jpg',
				'img/planets-cube/pertam/back.jpg',
				'img/planets-cube/pertam/left.jpg',
			],
			"Triton": [
				'img/planets-cube/triton/front.jpg',
				'img/planets-cube/triton/right.jpg',
				'img/planets-cube/triton/up.jpg',
				'img/planets-cube/triton/down.jpg',
				'img/planets-cube/triton/back.jpg',
				'img/planets-cube/triton/left.jpg',
			],
		}

		function hmfile(planetName) {
			planetName = planetName.toLowerCase();
			if (planetName.indexOf("earthlike") >= 0) {
				let materialArray = [
					'img/planets-cube/earthlike/hm/front.jpg',
					'img/planets-cube/earthlike/hm/right.jpg',
					'img/planets-cube/earthlike/hm/up.jpg',
					'img/planets-cube/earthlike/hm/down.jpg',
					'img/planets-cube/earthlike/hm/back.jpg',
					'img/planets-cube/earthlike/hm/left.jpg',
				];

				return materialArray;
			}
			if (planetName.indexOf("alien") >= 0) {
				let materialArray = [
					'img/planets-cube/alien/hm/front.jpg',
					'img/planets-cube/alien/hm/right.jpg',
					'img/planets-cube/alien/hm/up.jpg',
					'img/planets-cube/alien/hm/down.jpg',
					'img/planets-cube/alien/hm/back.jpg',
					'img/planets-cube/alien/hm/left.jpg',
				];

				return materialArray;
			}
			if (planetName.indexOf("europa") >= 0) {
				let materialArray = [
					'img/planets-cube/europa/hm/front.jpg',
					'img/planets-cube/europa/hm/right.jpg',
					'img/planets-cube/europa/hm/up.jpg',
					'img/planets-cube/europa/hm/down.jpg',
					'img/planets-cube/europa/hm/back.jpg',
					'img/planets-cube/europa/hm/left.jpg',
				];

				return materialArray;
			}
			if (planetName.indexOf("agaris") >= 0) {
				let materialArray = [
					'img/planets-cube/agaris/hm/front.jpg',
					'img/planets-cube/agaris/hm/right.jpg',
					'img/planets-cube/agaris/hm/up.jpg',
					'img/planets-cube/agaris/hm/down.jpg',
					'img/planets-cube/agaris/hm/back.jpg',
					'img/planets-cube/agaris/hm/left.jpg',
				];

				return materialArray;
			}
			if (planetName.indexOf("mars") >= 0) {
				let materialArray = [
					'img/planets-cube/mars/hm/front.jpg',
					'img/planets-cube/mars/hm/right.jpg',
					'img/planets-cube/mars/hm/up.jpg',
					'img/planets-cube/mars/hm/down.jpg',
					'img/planets-cube/mars/hm/back.jpg',
					'img/planets-cube/mars/hm/left.jpg',
				];

				return materialArray;
			}
			if (planetName.indexOf("moon") >= 0) {
				let materialArray = [
					'img/planets-cube/moon/hm/front.jpg',
					'img/planets-cube/moon/hm/right.jpg',
					'img/planets-cube/moon/hm/up.jpg',
					'img/planets-cube/moon/hm/down.jpg',
					'img/planets-cube/moon/hm/back.jpg',
					'img/planets-cube/moon/hm/left.jpg',
				];

				return materialArray;
			}
			if (planetName.indexOf("triton") >= 0) {
				let materialArray = [
					'img/planets-cube/triton/hm/front.jpg',
					'img/planets-cube/triton/hm/right.jpg',
					'img/planets-cube/triton/hm/up.jpg',
					'img/planets-cube/triton/hm/down.jpg',
					'img/planets-cube/triton/hm/back.jpg',
					'img/planets-cube/triton/hm/left.jpg',
				];

				return materialArray;
			}
			if (planetName.indexOf("titan") >= 0) {
				let materialArray = [
					'img/planets-cube/titan/hm/front.jpg',
					'img/planets-cube/titan/hm/right.jpg',
					'img/planets-cube/titan/hm/up.jpg',
					'img/planets-cube/titan/hm/down.jpg',
					'img/planets-cube/titan/hm/back.jpg',
					'img/planets-cube/titan/hm/left.jpg',
				];

				return materialArray;
			}
			if (planetName.indexOf("pertam") >= 0) {
				let materialArray = [
					'img/planets-cube/pertam/hm/front.jpg',
					'img/planets-cube/pertam/hm/right.jpg',
					'img/planets-cube/pertam/hm/up.jpg',
					'img/planets-cube/pertam/hm/down.jpg',
					'img/planets-cube/pertam/hm/back.jpg',
					'img/planets-cube/pertam/hm/left.jpg',
				];

				return materialArray;
			}

			return null; // textureLoader.load("img/planets/hm_earthlike.jpg");
		}

		let cachedMagicSphere;

		function magicSphereGeometry(radius, segments) {
			if (!cachedMagicSphere) {
				cachedMagicSphere = new THREE.BoxGeometry(1, 1, 1, segments, segments, segments);
				const uv = new THREE.Vector2();
				const repeat = new THREE.Vector2(1 / 3, 1 / 2);
				const offsets = [
					new THREE.Vector2(0, 0),
					new THREE.Vector2(0, 1 / 2),
					new THREE.Vector2(1 / 3, 0),
					new THREE.Vector2(1 / 3, 1 / 2),
					new THREE.Vector2(2 / 3, 0),
					new THREE.Vector2(2 / 3, 1 / 2)
				];
				const uvAttribute = cachedMagicSphere.getAttribute('uv');

				const midx = (idx) => {
					for (let i = 0; i < cachedMagicSphere.groups.count; i++) {
						const group = cachedMagicSphere.groups[i];
						if (group.start <= idx && idx - group.start < group.count) {
							return group.materialIndex;
						}
					}
					return 0;
				}

				for (let i = 0; i < cachedMagicSphere.index.count; i += 3) {
					const materialIndex = midx(i);
					for (let j = 0; j < 3; j++) {
						const faceIdx = cachedMagicSphere.index[i * 3 + j];
						uv.fromBufferAttribute(uvAttribute, faceIdx);
						uv.multiply(repeat).add(offsets[materialIndex]);
						uvAttribute.setXY(faceIdx, uv.x, uv.y);
					}
				}
				uvAttribute.needsUpdate = true;
			}
			const geometry = cachedMagicSphere.clone();
			const vertex = new THREE.Vector3();
			const normal = new THREE.Vector3();
			window.hx = geometry;
			window.vertex = THREE.Vector3;
			console.log(geometry);

			// texture is a collage; set offset/repeat per material index

			const positionAttribute = geometry.getAttribute('position');
			const normalAttribute = geometry.getAttribute('normal');
			// morph box into a sphere
			for (let i = 0; i < positionAttribute.count; i++) {
				vertex.fromBufferAttribute(positionAttribute, i);
				vertex.normalize();
				normalAttribute.setXYZ(i, vertex.x, vertex.y, vertex.z);
				vertex.multiplyScalar(radius);
				positionAttribute.setXYZ(i, vertex.x, vertex.y, vertex.z);
			}

			positionAttribute.needsUpdate = true;
			normalAttribute.needsUpdate = true;

			return geometry;
		}

		function planetsUpdateCallback(data) {
			console.log(data);
			document.getElementById('planets').innerHTML = '';
			const planetOl = document.createElement("ol");
			document.getElementById('planets').appendChild(planetOl);
			let firstPlanet;
			Object.keys(data).forEach((name) => {
				const voxelData = data[name];
				if (name != "" && voxelData.DebugName.indexOf("MyPlanet") > 0) {
					console.log(`Detected planet ${name}`);
					if (!firstPlanet && name.indexOf("Agaris") > - 1) {
						firstPlanet = name;
					}
					let map = null;
					if (voxelData.DebugName.indexOf("Agaris") >= 0) {
						map = planetTextures["Agaris"];
					}
					if (voxelData.DebugName.indexOf("EarthLike") >= 0) {
						map = planetTextures["EarthLike"];
					}
					if (voxelData.DebugName.indexOf("Moon") >= 0) {
						map = planetTextures["Moon"];
					}
					if (voxelData.DebugName.indexOf("Mars") >= 0) {
						map = planetTextures["Mars"];
					}
					if (voxelData.DebugName.indexOf("Europa") >= 0) {
						map = planetTextures["Europa"];
					}
					if (voxelData.DebugName.indexOf("Alien") >= 0) {
						map = planetTextures["Alien"];
					}
					if (voxelData.DebugName.indexOf("Titan") >= 0) {
						map = planetTextures["Titan"];
					}
					if (voxelData.DebugName.indexOf("Pertam") >= 0) {
						map = planetTextures["Pertam"];
					}
					if (voxelData.DebugName.indexOf("Triton") >= 0) {
						map = planetTextures["Triton"];
					}
					const maxHillSize = (1 + voxelData.HillParameters.Item2) * voxelData.Size;
					const minHillSize = (1 + voxelData.HillParameters.Item1) * voxelData.Size;
					const hillDelta = (maxHillSize - minHillSize) / 2;
					let mat = hmfile(voxelData.DebugName);
					if (mat.length > 0) {
						mat = mat.map((mat, idx) => {
							const hmTex = textureLoader.load(mat);
							const mapTex = (map !== null && map.length > idx) ? textureLoader.load(map[idx]) : null;
							return new THREE.MeshPhongMaterial({
								specular: 0x333333,
								shininess: 5,
								color: map === null || map.length === 0 ? pickOwnerColor() : null,
								map: mapTex,
								displacementMap: hmTex,
								displacementScale: hillDelta,
								normalScale: new THREE.Vector2(1, - 1),
								bumpMap: hmTex,
								bumpScale: hillDelta/2,
								// polygonOffset: true,
								// polygonOffsetFactor: 1, // positive value pushes polygon further away
								// polygonOffsetUnits: 1
							});
						});
					} else {
						mat = new THREE.MeshPhongMaterial({
							specular: 0x333333,
							shininess: 5,
							color: map === null ? pickOwnerColor() : null,
							map,
							displacementMap: mat,
							displacementScale: hillDelta,
							normalScale: new THREE.Vector2(1, - 1),
							bumpMap: mat,
							bumpScale: hillDelta/2,
							polygonOffset: true,
							polygonOffsetFactor: 1, // positive value pushes polygon further away
							polygonOffsetUnits: 1
						});
					}

					geometry = magicSphereGeometry(minHillSize / 2, 256);
					const mesh = new THREE.Mesh(geometry, mat);
					// mesh.rotation.y = Math.PI/2;
					mesh.position.x = voxelData.X;
					mesh.position.y = voxelData.Y;
					mesh.position.z = voxelData.Z;
					scene.add(mesh);
					voxelData.mesh = mesh;

					if (name.indexOf("Agaris") > -1) {
						console.log(`Creating water for ${name}`);
						const water = new THREE.SphereGeometry((minHillSize * 1.013) / 2, 64, 64);
						const waterMaterial = new THREE.MeshPhongMaterial({
							specular: 0x555555,
							shininess: 25,
							color: 0x1c526a,
							normalScale: new THREE.Vector2(1, - 1),
							opacity: 0.8,
							transparent: true,
						});
						const waterMesh = new THREE.Mesh(water, waterMaterial);
						waterMesh.rotation.y = 3.14;
						waterMesh.position.x = voxelData.X;
						waterMesh.position.y = voxelData.Y;
						waterMesh.position.z = voxelData.Z;
						scene.add(waterMesh);
						voxelData.waterMesh = waterMesh;
					}

					voxels[name] = voxelData;
					const p = document.createElement("li");
					p.onclick = () => { centerOn(name); }
					// p.setAttribute("onclick", `javascript:centerOn("${name}")`);
					p.innerText = name.split("-")[0];
					planetOl.appendChild(p);
				}
			});

			if (!planetsLoaded && firstPlanet.indexOf("Agaris") > -1) {
				planetsLoaded = true;
				centerOn(firstPlanet)
			}
		}

		function centerOn(voxelName) {
			console.log(`Centering on ${voxelName}`)
			document.getElementById('focusname').innerText = (`Focused on ${voxelName.split("-")[0]}`)
			const voxelData = voxels[voxelName];
			console.log(camera);
			const radius = voxelData.Size / 2;

			camera.position.x = voxelData.X;
			camera.position.y = voxelData.Y;
			camera.position.z = voxelData.Z + voxelData.Size * 5;
			controls.update();

			controls.target.x = voxelData.X;
			controls.target.y = voxelData.Y;
			controls.target.z = voxelData.Z;
			controls.update();
		}

		const messages = [];

		function newChatCallback(data) {
			messages.push(data);
			if (messages.length > 10) {
				messages.splice(0, 1);
			}

			while (msgList.childNodes.length != messages.length) {
				msgList.appendChild(document.createElement("li"));
			}

			for (let i = 0; i < messages.length; i++) {
				const msg = messages[i];
				msgList.childNodes[messages.length - 1 - i].innerHTML = `<B>${msg.From}</B>: ${msg.Message}`;
			}
		}

		function gridsCallback(data) {
			Object.keys(data).forEach((k) => {
				gridUpdateCallback({
					Grid: data[k],
					IsNew: true,
				});
			})
		}

		function gridUpdateCallback(data) {
			const gridData = data.Grid;
			gridData.EntityId = gridData.EntityId || gridData.Id;
			if (data.IsNew) {
				console.log(`New Grid: ${gridData.Name}, ${gridData.EntityId}`, gridData)
				if (!ownerColors[gridData.Faction]) {
					ownerColors[gridData.Faction] = pickOwnerColor();
				}
				const materialNormalMap = new THREE.MeshPhongMaterial({
					specular: 0x333333,
					color: ownerColors[gridData.Faction],
					shininess: 15,
				});

				// const geometry = new THREE.SphereGeometry(1000, 8, 8);
				const geometry = new THREE.SphereGeometry(100, 8, 8);
				const gridMesh = new THREE.Mesh(geometry, materialNormalMap);
				gridMesh.position.x = gridData.X;
				gridMesh.position.y = gridData.Y;
				gridMesh.position.z = gridData.Z;
				scene.add(gridMesh);

				const gridText = newText(gridData.Name);
				gridText.position.x = gridData.X;
				gridText.position.y = gridData.Y;
				gridText.position.z = gridData.Z;
				scene.add(gridText);

				const ng = {
					gridData: gridData,
					mesh: gridMesh,
					text: gridText,
				};
				grids[gridData.EntityId] = ng;
			} else if (data.IsDeleted) {
				const grid = grids[gridData.EntityId];
				if (grid) {
					scene.remove(grid.mesh);
					scene.remove(grid.text);
					delete (grids[gridData.EntityId]);
				}
			} else { // Update
				if (!grids[gridData.EntityId]) {
					// For some reason, we didnt added it.
					data.IsNew = true;
					return gridUpdateCallback(data);
				}
				const gridI = grids[gridData.EntityId];
				if (gridData.Name != gridI.gridData.Name) {
					console.log(`Grid ${gridData.EntityId} renamed from ${gridI.gridData.Name} to ${gridData.Name}`);
					scene.remove(gridI.text);
					gridI.text = newText(gridData.Name);
					scene.add(gridI.text);
				}
				const { mesh, text } = grids[gridData.EntityId];
				mesh.position.x = gridData.X;
				mesh.position.y = gridData.Y;
				mesh.position.z = gridData.Z;
				text.position.x = gridData.X;
				text.position.y = gridData.Y;
				text.position.z = gridData.Z;
				grids[gridData.EntityId].gridData = gridData;
			}
		}

		function onWindowResize() {

			SCREEN_HEIGHT = window.innerHeight;
			SCREEN_WIDTH = window.innerWidth;

			camera.aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
			camera.updateProjectionMatrix();

			renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
			composer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);

		}

		function animate() {
			requestAnimationFrame(animate);

			render();
			stats.update();
		}

		function render() {
			const delta = clock.getDelta();
			composer.render(delta);
		}

		function pickOwnerColor() {
			const names = Object.keys(colors);
			let found = false;
			let name, value;
			do {
				name = names[(Math.random() * names.length) >>> 0];
				value = colors[name];
				found = Object.keys(ownerColors)
					.map(k => ownerColors[k])
					.map(v => v == value)
					.reduce((a, v) => a || v, false);
			} while (found);
			return value;
		}

		const colors = {
			"Aliceblue            ": 0xf0f8ff,
			"Antiquewhite         ": 0xfaebd7,
			"Aqua                 ": 0x00ffff,
			"Aquamarine           ": 0x7fffd4,
			"Azure                ": 0xf0ffff,
			"Beige                ": 0xf5f5dc,
			"Bisque               ": 0xffe4c4,
			"Black                ": 0x000000,
			"Blanchedalmond       ": 0xffebcd,
			"Blue                 ": 0x0000ff,
			"Blueviolet           ": 0x8a2be2,
			"Brown                ": 0xa52a2a,
			"Burlywood            ": 0xdeb887,
			"Cadetblue            ": 0x5f9ea0,
			"Chartreuse           ": 0x7fff00,
			"Chocolate            ": 0xd2691e,
			"Coral                ": 0xff7f50,
			"Cornflowerblue       ": 0x6495ed,
			"Cornsilk             ": 0xfff8dc,
			"Crimson              ": 0xdc143c,
			"Cyan                 ": 0x00ffff,
			"Darkblue             ": 0x00008b,
			"Darkcyan             ": 0x008b8b,
			"Darkgoldenrod        ": 0xb8860b,
			"Darkgray             ": 0xa9a9a9,
			"Darkgreen            ": 0x006400,
			"Darkgrey             ": 0xa9a9a9,
			"Darkkhaki            ": 0xbdb76b,
			"Darkmagenta          ": 0x8b008b,
			"Darkolivegreen       ": 0x556b2f,
			"Darkorange           ": 0xff8c00,
			"Darkorchid           ": 0x9932cc,
			"Darkred              ": 0x8b0000,
			"Darksalmon           ": 0xe9967a,
			"Darkseagreen         ": 0x8fbc8f,
			"Darkslateblue        ": 0x483d8b,
			"Darkslategray        ": 0x2f4f4f,
			"Darkslategrey        ": 0x2f4f4f,
			"Darkturquoise        ": 0x00ced1,
			"Darkviolet           ": 0x9400d3,
			"Deeppink             ": 0xff1493,
			"Deepskyblue          ": 0x00bfff,
			"Dimgray              ": 0x696969,
			"Dimgrey              ": 0x696969,
			"Dodgerblue           ": 0x1e90ff,
			"Firebrick            ": 0xb22222,
			"Floralwhite          ": 0xfffaf0,
			"Forestgreen          ": 0x228b22,
			"Fuchsia              ": 0xff00ff,
			"Gainsboro            ": 0xdcdcdc,
			"Ghostwhite           ": 0xf8f8ff,
			"Gold                 ": 0xffd700,
			"Goldenrod            ": 0xdaa520,
			"Gray                 ": 0x808080,
			"Green                ": 0x008000,
			"Greenyellow          ": 0xadff2f,
			"Grey                 ": 0x808080,
			"Honeydew             ": 0xf0fff0,
			"Hotpink              ": 0xff69b4,
			"Indianred            ": 0xcd5c5c,
			"Indigo               ": 0x4b0082,
			"Ivory                ": 0xfffff0,
			"Khaki                ": 0xf0e68c,
			"Lavender             ": 0xe6e6fa,
			"Lavenderblush        ": 0xfff0f5,
			"Lawngreen            ": 0x7cfc00,
			"Lemonchiffon         ": 0xfffacd,
			"Lightblue            ": 0xadd8e6,
			"Lightcoral           ": 0xf08080,
			"Lightcyan            ": 0xe0ffff,
			"Lightgoldenrodyellow ": 0xfafad2,
			"Lightgray            ": 0xd3d3d3,
			"Lightgreen           ": 0x90ee90,
			"Lightgrey            ": 0xd3d3d3,
			"Lightpink            ": 0xffb6c1,
			"Lightsalmon          ": 0xffa07a,
			"Lightseagreen        ": 0x20b2aa,
			"Lightskyblue         ": 0x87cefa,
			"Lightslategray       ": 0x778899,
			"Lightslategrey       ": 0x778899,
			"Lightsteelblue       ": 0xb0c4de,
			"Lightyellow          ": 0xffffe0,
			"Lime                 ": 0x00ff00,
			"Limegreen            ": 0x32cd32,
			"Linen                ": 0xfaf0e6,
			"Magenta              ": 0xff00ff,
			"Maroon               ": 0x800000,
			"Mediumaquamarine     ": 0x66cdaa,
			"Mediumblue           ": 0x0000cd,
			"Mediumorchid         ": 0xba55d3,
			"Mediumpurple         ": 0x9370db,
			"Mediumseagreen       ": 0x3cb371,
			"Mediumslateblue      ": 0x7b68ee,
			"Mediumspringgreen    ": 0x00fa9a,
			"Mediumturquoise      ": 0x48d1cc,
			"Mediumvioletred      ": 0xc71585,
			"Midnightblue         ": 0x191970,
			"Mintcream            ": 0xf5fffa,
			"Mistyrose            ": 0xffe4e1,
			"Moccasin             ": 0xffe4b5,
			"Navajowhite          ": 0xffdead,
			"Navy                 ": 0x000080,
			"Oldlace              ": 0xfdf5e6,
			"Olive                ": 0x808000,
			"Olivedrab            ": 0x6b8e23,
			"Orange               ": 0xffa500,
			"Orangered            ": 0xff4500,
			"Orchid               ": 0xda70d6,
			"Palegoldenrod        ": 0xeee8aa,
			"Palegreen            ": 0x98fb98,
			"Paleturquoise        ": 0xafeeee,
			"Palevioletred        ": 0xdb7093,
			"Papayawhip           ": 0xffefd5,
			"Peachpuff            ": 0xffdab9,
			"Peru                 ": 0xcd853f,
			"Pink                 ": 0xffc0cb,
			"Plum                 ": 0xdda0dd,
			"Powderblue           ": 0xb0e0e6,
			"Purple               ": 0x800080,
			"Red                  ": 0xff0000,
			"Rosybrown            ": 0xbc8f8f,
			"Royalblue            ": 0x4169e1,
			"Saddlebrown          ": 0x8b4513,
			"Salmon               ": 0xfa8072,
			"Sandybrown           ": 0xf4a460,
			"Seagreen             ": 0x2e8b57,
			"Seashell             ": 0xfff5ee,
			"Sienna               ": 0xa0522d,
			"Silver               ": 0xc0c0c0,
			"Skyblue              ": 0x87ceeb,
			"Slateblue            ": 0x6a5acd,
			"Slategray            ": 0x708090,
			"Slategrey            ": 0x708090,
			"Snow                 ": 0xfffafa,
			"Springgreen          ": 0x00ff7f,
			"Steelblue            ": 0x4682b4,
			"Tan                  ": 0xd2b48c,
			"Teal                 ": 0x008080,
			"Thistle              ": 0xd8bfd8,
			"Tomato               ": 0xff6347,
			"Turquoise            ": 0x40e0d0,
			"Violet               ": 0xee82ee,
			"Wheat                ": 0xf5deb3,
			"White                ": 0xffffff,
			"Whitesmoke           ": 0xf5f5f5,
			"Yellow               ": 0xffff00,
			"Yellowgreen          ": 0x9acd32,
		}
	</script>
</body>

</html>